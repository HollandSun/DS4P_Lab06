---
title: "Lab 06 - Ugly charts and Simpson's paradox"
author: "Insert your name here"
date: "Insert date here"
output: github_document
---

### Load packages and data

```{r load-packages, message = FALSE}
library(tidyverse) 
library(dsbox)
library(mosaicData) 
```

### Exercise 1

Oh,In my contrast,I chose Lab06 for this week(I mean the fifth lab work for me,I just realized that I didn't change the lab number in contrast,So i quickly change it),
Although in this Lab I still have to learn some tips from previous Module, I just want to qucik up my steps.

```{r}
staff <- read_csv("data/instructional-staff.csv")
staff_long <- staff %>%
  pivot_longer(cols = -faculty_type, names_to = "year") %>%
  mutate(value = as.numeric(value))
staff_long %>%
  ggplot(aes(
    x = year,
    y = value,
    group = faculty_type,
    color = faculty_type
  )) +
  geom_line()
```


```{r better-plot1, fig.width=12, fig.height=6, warning=FALSE, message=FALSE}

staff_long <- staff %>%
  pivot_longer(cols = -faculty_type, names_to = "year") %>%
  mutate(value = as.numeric(value))

staff_long %>%
  ggplot(aes(
    x = year,
    y = value,
    group = faculty_type,
    color = ifelse(faculty_type == "Part-Time Faculty", "Part-Time Faculty", "Other"),
    linewidth = ifelse(faculty_type == "Part-Time Faculty", "highlight", "background"),
    alpha = ifelse(faculty_type == "Part-Time Faculty", "highlight", "background")
  )) +
  geom_line() +
  scale_color_manual(values = c("Part-Time Faculty" = "#000000", "Other" = "gray20")) +
  scale_linewidth_manual(values = c("highlight" = 1.2, "background" = 0.8)) +
  scale_alpha_manual(values = c("highlight" = 1, "background" = 0.8)) +
  geom_text(
    data = ~ .x %>% filter(year == "2011"),
    aes(label = faculty_type),
    hjust = 0,
    nudge_x = 0.1,
    size = 3,
    show.legend = FALSE
  ) +
  scale_x_discrete(expand = expansion(mult = c(0.05, 0.3))) +
  scale_y_continuous(labels = scales::percent_format(scale = 1))+
  labs(
    title = "Instructional Staff Employment Trends, 1975–2011",
    subtitle = "Part-time faculty has grown significantly over time",
    x = "Year",
    y = "Percentage of Total Instructional Staff"
  ) +
theme(
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )
```
The original line plot includes information for all instructional staff types, but it does not do a very good job of telling the main story that the part-time faculty has increased over time. First, all of the lines look visually similar (even though they are different colors), which makes the part-time faculty line hard to stand out. Second, as I said the different colors (or the legend) is confusing, it requires the reader to move back and forth between the legend and the color. This makes the figure feel less "simple". There are also some smaller issues, such as no title, the background gridlines looking cluttered, and the axis ticks not being very clear.

In the revised visualization, I highlighted the “Part-Time Faculty” group by using a thicker line with stronger contrast to emphasize its upward trend over time, and also fading the other types into light-gray lines. Second I removed the legend and labeled each line at its endpoint (I think it much straight forward). Finally, I adjusted the spacing between the axis titles and tick marks, removed unnecessary minor gridlines, centered the title, and added clearer axis labels with percentage units to improve overall readability.

### Exercise 2

For the original visualization, First, I think the information is seriously overloaded. All 216 countries are plotted at the same time, which makes the bar chart's x-axis and the pie chart slices almost impossible to distinguish. Second, the pie chart and density figure are not appropriate chart type here.Becasue there are this many categories with an extremely skewed distribution (I mean one or four contries almost have the whole part. Also I think the 3D effect make this even worse). Third,it's unclear what story the visualization is trying to tell. Is it comparing total production across countries? Highlighting the structural difference between capture and aquaculture? Or emphasizing some countries dominance in global fishery production? 


Here is my improvement plan:
- Define a clear narrative goal: compare the top fishery-producing countries and show the breakdown of capture vs. aquaculture.

- Filter to only the top 5 countries by total production to avoid information overload, with the rest  grouped as "Other" 

<span style="color: deepskyblue;"> *(Comments from Holland, Acutually it is top 10 first, but it looks not so good, because, the top 6 to 10 is too small and seem to be same with each other,so I change it into top 5)* </span>\

- Replace the chart with a horizontal stacked bar chart, makes it easy to compare both total production and the capture/aquaculture structure.

- Order countries by total production using.

- Use only two fill colors to clearly distinguish capture and aquaculture.

<span style="color: deepskyblue;"> *(ALso use the color associated with fish and ocean* </span>

- Simplify the x-axis labels using millions (e.g., "20M") instead of raw numbers like "20,000,000".

- Add a descriptive title and subtitle to guide the reader toward the main takeaway

```{r}
fisheries <- read_csv("data/fisheries.csv")

fisheries %>%
  filter(total >= 100000) %>%
  mutate(
    country = ifelse(rank(-total) <= 5, country, "Other")
  ) %>%
  group_by(country) %>%
  summarise(
    capture = sum(capture),
    aquaculture = sum(aquaculture),
    total = sum(total)
  ) %>%
  pivot_longer(cols = c(capture, aquaculture), 
               names_to = "type", values_to = "tonnage") %>%
  mutate(
    country = fct_reorder(country, tonnage, .fun = sum),
    country = fct_relevel(country, "Other", after = 0),
    type = str_to_title(type)
  ) %>%
  ggplot(aes(x = tonnage, y = country, fill = type)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = c("Aquaculture" = "#1b6b93", "Capture" = "#58b4d1")) +
  scale_x_continuous(labels = scales::label_number(scale = 1e-6, suffix = "M")) +
  labs(
    title = "Top 5 Fishery Producing Countries (2016)",
    subtitle = "Global fisheries have a skewed distribution",
    x = "Production (million tons)",
    y = NULL,
    fill = "Type"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = "top"
  )
```

For the aspirational improvements, I've also thinking about making this more interactive. I've seen a lot of cool interactive charts on websites, and my idea is that we could create a choropleth map where color intensity represents production levels. so you can immediately see which countries produce the most just by looking at the map. And when you hover over a specific country, it would pop up with the exact numbers and ranking.

Of course, one issue with just looking at total production is that countries with larger populations would naturally have higher numbers. (These may goe beyond our current topic) If we can bring in additional data. We could set up like six toggle options that let users switch between different views: total production, capture only, aquaculture only, and then per population(capita) versions of each. 

### Exercise 3
```{r}
data(Whickham)
```
####3.1

This is an observational study because the researchers did not assign participants to smoke or not smoke. They simply observed and recorded their existing smoking status at baseline and followed up 20 years later.

####3.2
There is ```r nrow(Whickham) ``` observations. Each observation represents one participant in the study with their smoking status recorded at baseline and survival outcome after 20 years.

####3.3
There is ```r ncol(Whickham) ``` observations :
`r colnames(Whickham)` 

specifically they are: 

outcome which is a factor: Alive / Dead

smoker  which is a factor: Yes / No

age     which is a numerical : age at baseline
```{r}
Whickham %>%
  ggplot(aes(x = outcome, fill = outcome)) +
  geom_bar() +
  scale_fill_manual(values = c("Alive" = "#56B4E9", "Dead" = "#E69F00")) +
  labs(title = "Distribution of Health Outcome") +
theme_minimal() +
  theme(legend.position = "none")

Whickham %>%
  ggplot(aes(x = smoker, fill = smoker)) +
  geom_bar() +
  scale_fill_manual(values = c("Yes" = "#D55E00", "No" = "#009E73")) +
  labs(title = "Distribution of Smoking Status") +
  theme_minimal() +
  theme(legend.position = "none")

Whickham %>%
  ggplot(aes(x = age)) +
  geom_density(fill = "#0072B2", alpha = 0.6) +
  labs(title = "Distribution of Age at Baseline") +
  theme_minimal()
```

####3.4
We would expect smokers to have worse health outcomes, a higher proportion of smokers should be dead after 20 years compared to non-smokers.

####3.5
```{r}
Whickham %>%
  ggplot(aes(x = smoker, fill = outcome)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    y = "Proportion",
    x = "Smoker"
  ) +
  theme_minimal()
# Conditional probabilities
Whickham %>%
  count(smoker, outcome) %>%
  group_by(smoker) %>%
  mutate(prop = n / sum(n))
```
the result likely shows that smokers have a **higher** survival rate than non-smokers, which is contradictive with expectation.

####3.6
```{r}
Whickham <- Whickham %>%
  mutate(age_cat = case_when(
    age <= 44 ~ "18-44",
    age > 44 & age <= 64 ~ "45-64",
    age > 64 ~ "65+"
  ))
```

####3.7
```{r}
Whickham %>%
  ggplot(aes(x = smoker, fill = outcome)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("Alive" = "#56B4E9", "Dead" = "#E69F00")) +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~ age_cat) +
  labs(
    y = "Proportion",
    x = "Smoker"
  ) +
  theme_minimal()

Whickham %>%
  count(smoker, age_cat, outcome) %>%
  group_by(smoker, age_cat) %>%
  mutate(prop = n / sum(n))
```

After faceting by age group, we can see that within each age group, smokers actually have a higher mortality rate than non-smokers (or at least no lower). 
I think that is the Simpson's Paradox we talked in this module.  I think The non-smoker group has a larger proportion of elderly people because many older individuals never smoked or because they had already quit. Since older people naturally have a higher death rate, when we mix all ages together, the result will be weird.
